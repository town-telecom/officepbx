### PHONE SYSTEM INSTALLATION LOG: ###

!!! EPEL:

yum -y install epel-release

###################################################################################################

!!! NET-TOOLS:

yum -y install net-tools

###################################################################################################

!!! NTP:

yum -y install ntp
systemctl enable ntp
systemctl enable ntpd
systemctl start ntpd
vim /etc/ntp.conf
systemctl restart ntpd
systemctl status ntpd

###################################################################################################

!!! SNGREP:

vim /etc/yum.repos.d/irontec.repo

[irontec]
name=Irontec RPMs repository
baseurl=http://packages.irontec.com/centos/$releasever/$basearch/

rpm --import http://packages.irontec.com/public.key

yum install sngrep

###################################################################################################

!!! MARIADB:

vim /etc/yum.repos.d/mariadb.repo

# MariaDB 10.3 CentOS repository list - created 2019-05-07 20:19 UTC
# http://downloads.mariadb.org/mariadb/repositories/
[mariadb]
name = MariaDB
baseurl = http://yum.mariadb.org/10.3/centos7-amd64
gpgkey=https://yum.mariadb.org/RPM-GPG-KEY-MariaDB
gpgcheck=1

yum install MariaDB-server MariaDB-client
systemctl enable mariadb
systemctl start mariadb
mysql_secure_installation
mysql -u root -p
...
GRANT ALL ON *.* TO 'root'@'%' IDENTIFIED BY '!!dfb@dm1n';
CREATE DATABASE asterisk;
GRANT ALL ON asterisk.* TO 'asterisk'@'%' IDENTIFIED BY '@t3r15k';
FLUSH PRIVILEGES;
USE asterisk;

SOURCE cdr.sql
...
DROP TABLE IF EXISTS cdr;
CREATE TABLE IF NOT EXISTS cdr (
  calldate datetime NOT NULL,
  clid varchar(80),
  src varchar(80),
  dst varchar(80),
  dcontext varchar(80),
  channel varchar(80),
  dstchannel varchar(80),
  lastapp varchar(80),
  lastdata varchar(80),
  duration int(11),
  billsec int(11),
  disposition varchar(45),
  amaflags int(11),
  accountcode varchar(20),
  uniqueid varchar(32),
  userfield varchar(255),
  peeraccount varchar(20),
  linkedid varchar(32),
  sequence int(11),
  callid varchar(100)
)  ENGINE=InnoDB;

SOURCE cel.sql
...
CREATE TABLE IF NOT EXISTS cel (
  id bigint NOT NULL AUTO_INCREMENT,
  eventtype varchar (30) NOT NULL,
  eventtime timestamp NOT NULL,
  userdeftype varchar(255) NOT NULL,
  cid_name varchar (80) NOT NULL,
  cid_num varchar (80) NOT NULL,
  cid_ani varchar (80) NOT NULL,
  cid_rdnis varchar (80) NOT NULL,
  cid_dnid varchar (80) NOT NULL,
  exten varchar (80) NOT NULL,
  context varchar (80) NOT NULL,
  channame varchar (80) NOT NULL,
  appname varchar (80) NOT NULL,
  appdata varchar (80) NOT NULL,
  amaflags int NOT NULL,
  accountcode varchar (20) NOT NULL,
  peeraccount varchar (20) NOT NULL,
  uniqueid varchar (150) NOT NULL,
  linkedid varchar (150) NOT NULL,
  userfield varchar (255) NOT NULL,
  peer varchar (80) NOT NULL,
  PRIMARY KEY (id)
) ENGINE=InnoDB;

SOURCE queue_log.sql
...
CREATE TABLE IF NOT EXISTS queue_log (
  id bigint(255) unsigned NOT NULL AUTO_INCREMENT,
  time varchar(26),
  callid varchar(40),
  queuename varchar(20),
  agent varchar(20),
  event varchar(20),
  data varchar(100),
  data1 varchar(40),
  data2 varchar(40),
  data3 varchar(40),
  data4 varchar(40),
  data5 varchar(40),
  created timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id),
  KEY queue (queuename),
  KEY event (event)
);

SOURCE pbx.sql
...
DROP TABLE IF EXISTS pbx,
CREATE TABLE pbx (
  id bigint NOT NULL AUTO_INCREMENT,
  ext varchar(6) NOT NULL,
  first_name varchar(20),
  last_name varchar(20),
  caller_id varchar(40),
  email varchar(60),
  phone_number varchar(20),
  mobile_number varchar(20),
  direct_number varchar(10),
  ip varchar(40),
  user_agent varchar(100),
  pin varchar(70) DEFAULT '123456',
  created timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  last_login timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  last_logout timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  logged_in boolean NOT NULL DEFAULT '0',
  active boolean NOT NULL DEFAULT '0',
  admin boolean NOT NULL DEFAULT '0',
  user varchar(40),
  password varchar(70),
  company_id varchar(20),
  notes varchar(150),
  PRIMARY KEY (ext),
  CONSTRAINT pbx_unique_values UNIQUE (id, ext, direct_number)
);

\q

vim /etc/my.cnf.d/server.cnf
...
bind-address = 0.0.0.0

systemctl restart mariadb
systemctl status mariadb

###################################################################################################

!!! LUA:

cd /usr/src
git clone https://github.com/keplerproject/luasql.git luasql
luasql/
vim config
...
# Installation directories

# Default prefix
PREFIX ?= /usr

# Lua version and dirs
LUA_SYS_VER ?= 5.1
LUA_LIBDIR ?= $(PREFIX)/lib64/lua/$(LUA_SYS_VER)
LUA_DIR ?= $(PREFIX)/share/lua/$(LUA_SYS_VER)
LUA_INC ?= $(PREFIX)/include/lua$(LUA_SYS_VER)

# OS dependent
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin) # MacOS
	LIB_OPTION ?= -bundle -undefined dynamic_lookup -mmacosx-version-min=10.3
else # Linux/BSD
	LIB_OPTION ?= -shared
endif

# driver specific params
# - MySQL
#DRIVER_LIBS_mysql ?= -L/usr/local/mysql/lib -lmysqlclient -lz
#DRIVER_INCS_mysql ?= -I/usr/local/mysql/include
DRIVER_LIBS_mysql ?= -L/usr/lib -lmysqlclient -lz
DRIVER_INCS_mysql ?= -I/usr/include/mysql
# - Oracle OCI8
DRIVER_LIBS_oci8 ?= -L/home/oracle/OraHome1/lib -lz -lclntsh
DRIVER_INCS_oci8 ?= -I/home/oracle/OraHome1/rdbms/demo \
                    -I/home/oracle/OraHome1/rdbms/public
# - PostgreSQL
#DRIVER_LIBS_postgres ?= -L/usr/local/pgsql/lib -lpq
#DRIVER_INCS_postgres ?= -I/usr/local/pgsql/include/
DRIVER_LIBS_postgres ?= -L/usr/lib -lpq
DRIVER_INCS_postgres ?= -I/usr/include/postgresql
# - SQLite
DRIVER_LIBS_sqlite ?= -lsqlite
DRIVER_INCS_sqlite ?=
# - SQLite3
DRIVER_LIBS_sqlite3 ?= -L/opt/local/lib -lsqlite3
DRIVER_INCS_sqlite3 ?= -I/opt/local/include
# - ODBC
DRIVER_LIBS_odbc ?= -L/usr/local/lib -lodbc
DRIVER_INCS_odbc ?= -DUNIXODBC -I/usr/local/include
# - Firebird
DRIVER_LIBS_firebird ?= -L/usr/local/firebird -lfbclient
DRIVER_INCS_firebird ?=

# general compilation parameters
WARN = -Wall -Wmissing-prototypes -Wmissing-declarations -pedantic
INCS = -I$(LUA_INC)
DEFS =
CFLAGS = -O2 -std=gnu99 $(WARN) -fPIC $(DRIVER_INCS) $(INCS) \
         -DLUASQL_VERSION_NUMBER='"$V"' $(DEFS)
CC= gcc

make odbc
make install

vim ~/lua-odbc.lua
...
DSN = "asterisk-connector"
DBUSER = "user"
DBPASSWORD = "pass"
DBHOST = "ip"
DBPORT = "3306"
luasql = require "luasql.odbc"
--
env = luasql.odbc()
con = env:connect(DSN, DBUSER, DBPASSWORD, DBHOST, DBPORT)
cur = con:execute('SELECT SYSDATE();')
print(env,con,cur)
row = cur:fetch()
DATE = row
print ("El SYSDATE en la BD es => " .. DATE)
cur:close()
con:close()
env:close()

###################################################################################################

!!! ASTERISK:

yum -y install git
git clone -b 16 http://gerrit.asterisk.org/asterisk asterisk-16
cd asterisk-16/
./contrib/scripts/install_prereq install
./contrib/scripts/get_ilbc_source.sh
./contrib/scripts/get_mp3_source.sh
./contrib/scripts/get_swagger_ui.sh
cd /usr/src
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python get-pip.py
pip -V
cd asterisk-16/contrib/ast-db-manage/
pip install alembic
cp config.ini.sample config.ini
vim config.ini
...
sqlalchemy.url = mysql://root:lsdfb@dm1n@192.168.10.122/asterisk

yum install MariaDB-client
yum install python-dateutil
yum install MySQL-python
alembic -c config.ini upgrade head
cd ..
cd ..
./configure --with-jansson-bundled
make menuselect
make
make install
make samples
make config
reboot
cd /etc/asterisk
for FILE in *; do cp ${FILE} ${FILE}.backup; done
cd /usr/src
mkdir odbc_package
cd odbc_package/
wget https://downloads.mariadb.com/Connectors/odbc/connector-odbc-3.0.9/mariadb-connector-odbc-3.0.9-ga-rhel7-x86_64.tar.gz
tar -zxvf mariadb-connector-odbc-3.0.9-ga-rhel7-x86_64.tar.gz
install lib64/libmaodbc.so /usr/lib64
vim /etc/odbcinst.ini
...
[MariaDB]
Description = ODBC for MySQL
Driver = /usr/lib64/libmaodbc.so
Setup = /usr/lib64/libodbcmyS.so
UsageCount = 2

vim /etc/odbc.ini
...
[asterisk-connector]
Driver = MariaDB
Description = MariaDB connection to ‘asterisk’ database
Server = 192.168.10.122
Port = 3306
Database = asterisk

mysql -h 192.168.10.122 -u root -p
...
Enter password:

odbcinst -q -d
...
[MariaDB]

echo "select 1" | isql -v asterisk-connector root '!!dfb@dm1n'
echo "select 1" | isql -v asterisk-connector asterisk '@t3r15k'
...
+---------------------------------------+
| Connected!                            |
|                                       |
| sql-statement                         |
| help [tablename]                      |
| quit                                  |
|                                       |
+---------------------------------------+
SQL> select 1
+------------+
| 1          |
+------------+
| 1          |
+------------+
SQLRowCount returns 1
1 rows fetched